{% extends 'base.html.twig' %}

{% block title %}{{ cave.nom }}{% endblock %}

{% block body %}
  {% set isOwner = app.user and app.user == cave.creePar %}

  <section class="cave-detail">
  <div class="cave-header">
    <h1 id="cave-name" contenteditable="false">{{ cave.nom }}</h1>

  {% if isOwner and not cave.isPrivee %}
    <div class="btn-edit-wrapper">
      <button id="edit-name-btn" class="btn-edit small">‚úèÔ∏è Modifier le nom</button>
    </div>
  {% endif %}

  </div>

    <div class="description-image-container">
      <div class="image-wrapper">
        <img id="cave-image"
            src="{{ cave.image and cave.image != 'default-cave.jpg' 
                ? asset('uploads/caves/' ~ cave.image) 
                : asset('images/default-cave.jpg') }}" 
            alt="{{ cave.nom }}">

        {% if isOwner %}
          <button id="change-image-btn" class="btn-edit small">üñºÔ∏è Modifier l‚Äôimage</button>
          <input type="file" id="image-input" style="display: none;">
        {% endif %}
      </div>

      <div class="description-block">
        <p id="cave-description" contenteditable="false">
          {{ cave.description ?? 'Pas de description fournie.' }}
        </p>
        {% if isOwner %}
          <button id="edit-desc-btn" class="btn-edit small">üìù Modifier la description</button>
        {% endif %}
        {% if isOwner %}
          <div class="add-wine-button-wrapper">
          <a href="{{ path('app_vin_listes', { cave: cave.id }) }}" class="btn-add-wine">
            ‚ûï Ajouter un vin √† cette cave
          </a>
          </div>
        {% endif %}
        
          {% if isOwner and not cave.isPrivee %}
          <a href="#" class="btn-delete-cave open-delete-modal">
            üóëÔ∏è Supprimer cette cave
          </a>
          <form id="delete-cave-form"
                method="POST"
                action="{{ path('app_cave_supprimer', { id: cave.id }) }}">
            <input type="hidden" name="_token" value="{{ csrf_token('delete-cave-' ~ cave.id) }}">
          </form>

        {% endif %}

        {% if cave.bouteilles is not empty %}
            {% set total = 0 %}
            {% for vin in cave.bouteilles %}
              {% set total = total + vin.prix %}
            {% endfor %}
            <p>Moyenne des prix : {{ (total / cave.bouteilles|length)|number_format(2, '.', ',') }} ‚Ç¨</p>
          {% endif %}
          </div>
        </div>
        
              {% if cave.bouteilles|length > 0 %}
        <div class="wine-list">
          {% for vin in cave.bouteilles %}
            <div class="wine-card">
              <div class="flip-card" onclick="this.classList.toggle('flipped')">
                <div class="flip-card-inner">
                  <div class="flip-card-front">
                    <h3>{{ vin.nom|upper }}</h3>
                    <img src="{{ asset('uploads/vins/' ~ vin.images) }}" alt="{{ vin.nom }}">
                          {% if app.user and cave.utilisateur.id == app.user.id %}
                            <button type="button"
                                    class="btn-remove"
                                    data-vin="{{ vin.id }}"
                                    data-nom="{{ vin.nom }}">
                              ‚ùå Retirer
                            </button>
                          {% endif %}
                  </div>
                  <div class="flip-card-back">
                    <p>Ann√©e : {{ vin.annee }}</p>
                    <p>Pays : {{ vin.pays.nom }}</p>
                    <p>R√©gion : {{ vin.region.nom }}</p>
                    <p>C√©page : {{ vin.cepage.nom }}</p>
                    <a href="{{ path('vin_show', {'id': vin.id}) }}" class="btn-flip">En savoir plus</a>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        {% else %}
          <div class="wine-list">
            <div class="wine-card empty" onclick="window.location.href='{{ path('app_vin_listes', { cave: cave.id }) }}'">
              <img src="{{ asset('images/add-vin-placeholder.png') }}" alt="Ajouter un vin">
              <p class="btn-edit small">Ajouter un vin</p>
            </div>
          </div>
        {% endif %}
                <form method="POST"
                action="{{ path('app_toggle_visibilite_cave', { id: cave.id }) }}"
                class="form-toggle-privee">
            <input type="hidden" name="_token" value="{{ csrf_token('toggle-cave-' ~ cave.id) }}">
            {% if isOwner %}
              <button type="submit" class="btn-toggle-privee">
                {% if cave.isPrivee %}
                  üîì Rendre la cave publique
                {% else %}
                  üîí Rendre la cave priv√©e
                {% endif %}
              </button>
              {% endif %}
          </form>
        </div>
  </section>

  <div id="confirmModal" class="modal" style="display:none;">
    <div class="modal-content">
      <p>√ätes-vous s√ªr de vouloir retirer <strong id="vinName"></strong> de cette cave ?</p>
      <form method="post" id="removeForm" action="{{ path('app_retirer_vin', { caveId: cave.id }) }}">
        <input type="hidden" name="vin_id" id="vinIdInput">
        <button type="submit" class="confirm-btn">Oui, retirer</button>
        <button type="button" class="cancel-btn">Annuler</button>
      </form>
    </div>
  </div>
  <div id="deleteCaveModal" class="modal" style="display: none;">
    <div class="modal-content">
      <p>√ätes-vous s√ªr de vouloir <strong>supprimer d√©finitivement</strong> cette cave ?</p>
      <div class="modal-buttons">
        <button type="submit" form="delete-cave-form" class="confirm-btn">Oui, supprimer</button>
        <button type="button" class="cancel-btn cancel-delete-cave">Annuler</button>
      </div>
    </div>
  </div>
  
  <script>
      document.querySelectorAll('.btn-remove').forEach(button => {
        button.addEventListener('click', (e) => {
          e.preventDefault();

          const vinId = button.dataset.vin;
          const vinNom = button.dataset.nom;
          const caveId = '{{ cave.id }}';

          // Mise √† jour de la modal
          document.getElementById('vinIdInput').value = vinId;
          document.getElementById('vinName').textContent = vinNom;
          // Mise √† jour de l'URL d'action du formulaire
          document.getElementById('removeForm').action = `/cave/${caveId}/retirer-vin/${vinId}`;

          // Mise √† jour de l'URL du formulaire dans la modal
          const form = document.getElementById('removeForm');
          form.action = `/cave/${caveId}/retirer-vin/${vinId}`;

          document.getElementById('confirmModal').style.display = 'flex';
        });
      });

      // Gestion du bouton "Annuler"
      document.querySelector('#confirmModal .cancel-btn')?.addEventListener('click', () => {
        document.getElementById('confirmModal').style.display = 'none';
      });
    // Ouvre la modale de suppression de la cave
  document.querySelector('.open-delete-modal')?.addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('deleteCaveModal').style.display = 'flex';
  });

  // Ferme la modale si on clique sur "Annuler"
  document.querySelector('.cancel-delete-cave')?.addEventListener('click', () => {
    document.getElementById('deleteCaveModal').style.display = 'none';
  });
  </script>

  {% if isOwner %}
    <script>
      const saveUrl = '{{ path('app_cave_inline_update', { id: cave.id }) }}';
      const imageUploadUrl = '{{ path('app_cave_update_image', { id: cave.id }) }}';
    </script>
  {% endif %}
{% endblock %}
